#!/bin/bash
#
# Post-installation script for TiosVPN
# Automatically installs OpenVPN if Homebrew is available
#

echo "Running TiosVPN post-installation..."

# Set correct permissions for the app
chmod +x /Applications/TiosVPN.app/Contents/MacOS/TiosVPN
chmod +x /Applications/TiosVPN.app/Contents/Resources/TiosVPN-GUI.sh
chmod +x /Applications/TiosVPN.app/Contents/Resources/vpn-manager.sh

# Install CLI tool
if [ -f "/Applications/TiosVPN.app/Contents/Resources/tiosvpn" ]; then
    cp /Applications/TiosVPN.app/Contents/Resources/tiosvpn /usr/local/bin/tiosvpn 2>/dev/null || true
    cp /Applications/TiosVPN.app/Contents/Resources/vpn-manager.sh /usr/local/bin/vpn-manager.sh 2>/dev/null || true
    chmod +x /usr/local/bin/tiosvpn /usr/local/bin/vpn-manager.sh 2>/dev/null || true
fi

# Get the actual user (not root) who is running the installer
ACTUAL_USER="${USER}"
if [ "$ACTUAL_USER" = "root" ]; then
    ACTUAL_USER=$(stat -f "%Su" /dev/console)
fi

echo "Checking OpenVPN installation..."

# Check if OpenVPN is already installed
if command -v openvpn &> /dev/null; then
    echo "✓ OpenVPN is already installed"
elif [ -f "/usr/local/opt/openvpn/sbin/openvpn" ] || [ -f "/opt/homebrew/opt/openvpn/sbin/openvpn" ]; then
    echo "✓ OpenVPN is already installed via Homebrew"
else
    # OpenVPN not found - try to install via Homebrew if available
    echo "OpenVPN not found. Attempting to install..."

    if [ -f "/opt/homebrew/bin/brew" ] || [ -f "/usr/local/bin/brew" ]; then
        # Homebrew is installed - use it to install OpenVPN
        if [ -f "/opt/homebrew/bin/brew" ]; then
            BREW_PATH="/opt/homebrew/bin/brew"
        else
            BREW_PATH="/usr/local/bin/brew"
        fi

        echo "Installing OpenVPN via Homebrew..."
        su - "$ACTUAL_USER" -c "$BREW_PATH install openvpn" 2>&1

        # Verify installation
        if command -v openvpn &> /dev/null || [ -f "/usr/local/opt/openvpn/sbin/openvpn" ] || [ -f "/opt/homebrew/opt/openvpn/sbin/openvpn" ]; then
            echo "✓ OpenVPN installed successfully!"
        else
            echo "⚠ OpenVPN installation completed but may need PATH update"
        fi
    else
        # Homebrew not found - skip automatic installation
        echo "⚠ Homebrew not found. OpenVPN not installed."
        echo ""
        echo "To use TiosVPN, please install OpenVPN:"
        echo "  1. Install Homebrew: https://brew.sh"
        echo "  2. Then run: brew install openvpn"
    fi
fi

echo "TiosVPN installation complete!"

exit 0
