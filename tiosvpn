#!/bin/bash
#
# TiosVPN CLI - Command-line interface
#

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VPN_MANAGER="$SCRIPT_DIR/vpn-manager.sh"

show_help() {
    cat << EOF

TiosVPN Command Line Interface

Usage: tiosvpn [command]

Commands:
    setup           Setup VPN credentials (first-time setup)
    connect         Connect to VPN (will prompt for MFA code)
    disconnect      Disconnect from VPN
    status          Show current connection status
    update-config   Download latest VPN configuration
    help            Show this help message

Examples:
    tiosvpn setup
    tiosvpn connect
    tiosvpn status
    tiosvpn disconnect

EOF
}

# Main
case "${1:-help}" in
    setup)
        echo "=== TiosVPN Setup ==="
        echo
        read -p "Enter username: " username
        read -sp "Enter password: " password
        echo

        if [ -z "$username" ] || [ -z "$password" ]; then
            echo "✗ Error: Username and password cannot be empty"
            exit 1
        fi

        "$VPN_MANAGER" save-credentials "$username" "$password"
        exit $?
        ;;

    connect)
        if [ "$("$VPN_MANAGER" credentials-exist)" = "no" ]; then
            echo "✗ Error: No credentials found. Please run 'tiosvpn setup' first"
            exit 1
        fi

        read -p "Enter MFA code (6 digits): " mfa_code

        if [ ${#mfa_code} -ne 6 ] || ! [[ "$mfa_code" =~ ^[0-9]+$ ]]; then
            echo "✗ Error: MFA code must be exactly 6 digits"
            exit 1
        fi

        "$VPN_MANAGER" connect "$mfa_code"
        exit $?
        ;;

    disconnect)
        "$VPN_MANAGER" disconnect
        exit $?
        ;;

    status)
        "$VPN_MANAGER" status
        exit 0
        ;;

    update-config)
        "$VPN_MANAGER" download-config
        exit $?
        ;;

    help|--help|-h)
        show_help
        exit 0
        ;;

    *)
        echo "✗ Error: Unknown command '$1'"
        show_help
        exit 1
        ;;
esac
